# Docker 多架构构建和保存指南

## 概述

本指南专门说明如何为 ARM64 和 AMD64 架构构建和保存 OCR 服务的 Docker 镜像。

## 架构说明

| 架构名称 | Docker平台 | 适用设备 |
|----------|------------|----------|
| AMD64 | linux/amd64 | Intel/AMD处理器的服务器、PC |
| ARM64 | linux/arm64 | Apple Silicon Mac、ARM服务器、树莓派4+ |

## 构建和保存镜像

### 方法1：使用buildx构建（推荐）

#### AMD64 架构（buildx构建 + 保存）

```bash
# 1. 创建并使用buildx构建器
docker buildx create --name multiarch-builder --use

# 2. 构建 AMD64 镜像
docker buildx build --platform linux/amd64 -t my-ocr-service:v1.0-amd64 --load .

# 3. 验证构建结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-amd64 | grep Architecture
# 应该显示: "Architecture": "amd64"

# 4. 保存为压缩文件（推荐）
docker save my-ocr-service:v1.0-amd64 | gzip > my-ocr-service-v1.0-amd64.tar.gz

# 5. 查看文件大小
ls -lh my-ocr-service-v1.0-amd64.tar.gz
```

#### ARM64 架构（buildx构建 + 保存）

```bash
# 1. 创建并使用buildx构建器（如果未创建）
docker buildx create --name multiarch-builder --use

# 2. 构建 ARM64 镜像
docker buildx build --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 --load .

# 3. 验证构建结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-arm64 | grep Architecture
# 应该显示: "Architecture": "arm64"

# 4. 保存为压缩文件（推荐）
docker save my-ocr-service:v1.0-arm64 | gzip > my-ocr-service-v1.0-arm64.tar.gz

# 5. 查看文件大小
ls -lh my-ocr-service-v1.0-arm64.tar.gz
```

### 方法2：传统构建方式

#### AMD64 架构（构建 + 保存）

```bash
# 1. 构建 AMD64 镜像（明确指定平台）
docker build --platform linux/amd64 -t my-ocr-service:v1.0-amd64 .

# 2. 验证构建结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-amd64 | grep Architecture
# 应该显示: "Architecture": "amd64"

# 3. 保存为压缩文件（推荐）
docker save my-ocr-service:v1.0-amd64 | gzip > my-ocr-service-v1.0-amd64.tar.gz

# 4. 查看文件大小
ls -lh my-ocr-service-v1.0-amd64.tar.gz
```

#### ARM64 架构（构建 + 保存）

```bash
# 1. 构建 ARM64 镜像（明确指定平台）
docker build --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 .

# 2. 验证构建结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-arm64 | grep Architecture
# 应该显示: "Architecture": "arm64"

# 3. 保存为压缩文件（推荐）
docker save my-ocr-service:v1.0-arm64 | gzip > my-ocr-service-v1.0-arm64.tar.gz

# 4. 查看文件大小
ls -lh my-ocr-service-v1.0-arm64.tar.gz
```

## 加载镜像

### AMD64 架构加载

```bash
# 1. 加载 AMD64 压缩镜像
gunzip -c my-ocr-service-v1.0-amd64.tar.gz | docker load

# 2. 验证加载结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-amd64 | grep Architecture
# 应该显示: "Architecture": "amd64"

# 3. 启动服务（使用AMD64专用配置）
docker-compose -f docker-compose-amd64.yml up -d

# 4. 测试服务
curl http://localhost:9000/health
```

### ARM64 架构加载

```bash
# 1. 加载 ARM64 压缩镜像
gunzip -c my-ocr-service-v1.0-arm64.tar.gz | docker load

# 2. 验证加载结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-arm64 | grep Architecture
# 应该显示: "Architecture": "arm64"

# 3. 启动服务（使用ARM64专用配置）
docker-compose -f docker-compose-arm64.yml up -d

# 4. 测试服务
curl http://localhost:9000/health
```

### docker-compose.yml 配置示例

#### AMD64 架构配置 (docker-compose-amd64.yml)

```yaml
version: '3.8'

services:
  ocr-server:
    image: my-ocr-service:v1.0-amd64
    
    container_name: ocr-server-amd64
    restart: always
    ports:
      - "9000:9000"

    environment:
      - TZ=Asia/Shanghai

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
```

#### ARM64 架构配置 (docker-compose-arm64.yml)

```yaml
version: '3.8'

services:
  ocr-server:
    image: my-ocr-service:v1.0-arm64
    platform: linux/arm64  # 强制指定平台
    
    container_name: ocr-server-arm64
    restart: always
    ports:
      - "9000:9000"

    environment:
      - TZ=Asia/Shanghai
      # ARM优化配置
      - OMP_NUM_THREADS=4
      - OPENBLAS_NUM_THREADS=4

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s  # ARM启动可能稍慢

    # ARM平台资源限制
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
```

#### 使用不同架构的配置文件

```bash
# AMD64 架构启动
docker-compose -f docker-compose-amd64.yml up -d

# ARM64 架构启动
docker-compose -f docker-compose-arm64.yml up -d

# 查看服务状态
docker-compose -f docker-compose-amd64.yml ps
docker-compose -f docker-compose-arm64.yml ps

# 停止服务
docker-compose -f docker-compose-amd64.yml down
docker-compose -f docker-compose-arm64.yml down
```

### 加载未压缩镜像

```bash
# 如果是 .tar 文件（未压缩）
docker load -i my-ocr-service-v1.0-amd64.tar
docker load -i my-ocr-service-v1.0-arm64.tar

# 验证加载的镜像架构
docker inspect my-ocr-service:v1.0-amd64 | grep Architecture
docker inspect my-ocr-service:v1.0-arm64 | grep Architecture

# 使用对应的配置文件启动服务
docker-compose -f docker-compose-amd64.yml up -d  # AMD64
docker-compose -f docker-compose-arm64.yml up -d  # ARM64
```

### 检查系统架构

```bash
# 查看当前系统架构
uname -m

# x86_64    -> 使用 AMD64 镜像
# aarch64   -> 使用 ARM64 镜像  
# arm64     -> 使用 ARM64 镜像
```

## 使用说明

### 1. 准备工作

确保以下文件存在：
- `Dockerfile` (AMD64版本)
- `Dockerfile.arm` (ARM64版本)
- `requirements.txt`
- `app.py`

### 2. 执行构建

```bash
# 保存脚本为 build-and-save.sh
chmod +x build-and-save.sh
./build-and-save.sh
```

### 3. 验证结果

```bash
# 检查生成的文件
ls -lh *.tar.gz

# 验证镜像内容
docker load -i my-ocr-service-v1.0-amd64.tar.gz
docker images | grep my-ocr-service
```

## 注意事项

1. **构建时间**：ARM64 镜像构建时间通常比 AMD64 长 20-50%
2. **文件大小**：两个架构的镜像大小可能略有差异
3. **依赖兼容性**：确保所有 Python 包都支持目标架构
4. **测试验证**：构建完成后建议在对应架构的设备上测试运行

## 故障排除

### 常见问题

1. **架构不匹配错误 (exec format error)**
   ```bash
   # 问题：在ARM64系统上运行AMD64镜像，或反之
   # 解决：检查镜像实际架构
   docker inspect my-ocr-service:v1.0-arm64 | grep Architecture
   
   # 如果架构不匹配，重新构建正确架构的镜像
   docker rmi my-ocr-service:v1.0-arm64
   docker build --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 .
   ```

2. **构建时架构错误**
   ```bash
   # 问题：使用Dockerfile.arm构建但架构仍然是amd64
   # 解决方案1：使用buildx构建（推荐）
   docker buildx create --name multiarch-builder --use
   docker buildx build --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 --load .
   
   # 解决方案2：明确指定目标平台
   docker build --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 .
   ```

3. **buildx构建失败**
   ```bash
   # 检查buildx是否可用
   docker buildx version
   
   # 创建新的构建器
   docker buildx create --name multiarch-builder --use
   
   # 清理并重新构建
   docker buildx prune -f
   docker buildx build --no-cache --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 --load .
   ```

3. **构建失败**
   ```bash
   # 清理构建缓存
   docker builder prune -f
   
   # 重新构建（无缓存）
   docker build --no-cache --platform linux/amd64 -t my-ocr-service:v1.0-amd64 .
   docker build --no-cache --platform linux/arm64 -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 .
   ```

4. **保存失败**
   ```bash
   # 检查磁盘空间
   df -h
   
   # 清理无用镜像
   docker image prune -f
   ```

5. **镜像包验证**
   ```bash
   # 检查镜像架构
   docker inspect my-ocr-service:v1.0-amd64 | grep Architecture
   docker inspect my-ocr-service:v1.0-arm64 | grep Architecture
   
   # 检查镜像大小
   docker images | grep my-ocr-service
   ```

### 架构验证清单

在构建和部署前，请确认：

1. **系统架构检查**
   ```bash
   uname -m
   # x86_64 -> 需要AMD64镜像
   # aarch64 -> 需要ARM64镜像
   ```

2. **镜像架构验证**
   ```bash
   docker inspect [镜像名] | grep Architecture
   # 确保镜像架构与系统架构匹配
   ```

3. **配置文件选择**
   ```bash
   # AMD64系统使用
   docker-compose -f docker-compose-amd64.yml up -d
   
   # ARM64系统使用
   docker-compose -f docker-compose-arm64.yml up -d
   ```

### 性能优化建议

1. **ARM64平台优化**
   - 设置合适的线程数：`OMP_NUM_THREADS=4`
   - 限制内存使用：最大2GB
   - 增加启动等待时间：15秒

2. **构建优化**
   - 使用多阶段构建减小镜像大小
   - 合理使用构建缓存
   - 清理不必要的依赖包

3. **buildx优势**
   - 更好的跨平台支持
   - 更可靠的架构指定
   - 支持同时构建多架构
   - 更好地处理平台特定依赖