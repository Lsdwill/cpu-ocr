# Docker 多架构构建和保存指南

## 概述

本指南专门说明如何为 ARM64 和 AMD64 架构构建和保存 OCR 服务的 Docker 镜像。

## 架构说明

| 架构名称 | Docker平台 | 适用设备 |
|----------|------------|----------|
| AMD64 | linux/amd64 | Intel/AMD处理器的服务器、PC |
| ARM64 | linux/arm64 | Apple Silicon Mac、ARM服务器、树莓派4+ |

## 构建和保存镜像

### AMD64 架构（构建 + 保存）

```bash
# 1. 构建 AMD64 镜像
docker build -t my-ocr-service:v1.0-amd64 .

# 2. 验证构建结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-amd64 | grep Architecture

# 3. 保存为压缩文件（推荐）
docker save my-ocr-service:v1.0-amd64 | gzip > my-ocr-service-v1.0-amd64.tar.gz

# 4. 查看文件大小
ls -lh my-ocr-service-v1.0-amd64.tar.gz
```

### ARM64 架构（构建 + 保存）

```bash
# 1. 构建 ARM64 镜像
docker build -f Dockerfile.arm -t my-ocr-service:v1.0-arm64 .

# 2. 验证构建结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-arm64 | grep Architecture

# 3. 保存为压缩文件（推荐）
docker save my-ocr-service:v1.0-arm64 | gzip > my-ocr-service-v1.0-arm64.tar.gz

# 4. 查看文件大小
ls -lh my-ocr-service-v1.0-arm64.tar.gz
```

## 加载镜像

### AMD64 架构加载

```bash
# 1. 加载 AMD64 压缩镜像
gunzip -c my-ocr-service-v1.0-amd64.tar.gz | docker load

# 2. 验证加载结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-amd64 | grep Architecture

# 3. 启动服务（使用AMD64配置文件）
docker-compose -f docker-compose-amd64.yml up -d

# 4. 测试服务
curl http://localhost:9000/health
```

### ARM64 架构加载

```bash
# 1. 加载 ARM64 压缩镜像
gunzip -c my-ocr-service-v1.0-arm64.tar.gz | docker load

# 2. 验证加载结果
docker images | grep my-ocr-service
docker inspect my-ocr-service:v1.0-arm64 | grep Architecture

# 3. 启动服务（使用ARM64配置文件）
docker-compose -f docker-compose-arm64.yml up -d

# 4. 测试服务
curl http://localhost:9000/health
```

### docker-compose.yml 配置示例

#### AMD64 架构配置 (docker-compose-amd64.yml)

```yaml
version: '3.8'

services:
  ocr-server:
    image: my-ocr-service:v1.0-amd64
    
    container_name: ocr-server-amd64
    restart: always
    ports:
      - "9000:9000"

    environment:
      - TZ=Asia/Shanghai

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
```

#### ARM64 架构配置 (docker-compose-arm64.yml)

```yaml
version: '3.8'

services:
  ocr-server:
    image: my-ocr-service:v1.0-arm64
    
    container_name: ocr-server-arm64
    restart: always
    ports:
      - "9000:9000"

    environment:
      - TZ=Asia/Shanghai
      # ARM优化配置
      - OMP_NUM_THREADS=4
      - OPENBLAS_NUM_THREADS=4

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s  # ARM启动可能稍慢

    # ARM平台资源限制
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
```

#### 使用不同架构的配置文件

```bash
# AMD64 架构启动
docker-compose -f docker-compose-amd64.yml up -d

# ARM64 架构启动
docker-compose -f docker-compose-arm64.yml up -d

# 查看服务状态
docker-compose -f docker-compose-amd64.yml ps
docker-compose -f docker-compose-arm64.yml ps

# 停止服务
docker-compose -f docker-compose-amd64.yml down
docker-compose -f docker-compose-arm64.yml down
```

### 加载未压缩镜像

```bash
# 如果是 .tar 文件（未压缩）
docker load -i my-ocr-service-v1.0-amd64.tar
docker load -i my-ocr-service-v1.0-arm64.tar

# 验证加载
docker images | grep my-ocr-service

# 启动服务
docker-compose up -d
```

### 检查系统架构

```bash
# 查看当前系统架构
uname -m

# x86_64    -> 使用 AMD64 镜像
# aarch64   -> 使用 ARM64 镜像  
# arm64     -> 使用 ARM64 镜像
```

## 使用说明

### 1. 准备工作

确保以下文件存在：
- `Dockerfile` (AMD64版本)
- `Dockerfile.arm` (ARM64版本)
- `requirements.txt`
- `app.py`

### 2. 执行构建

```bash
# 保存脚本为 build-and-save.sh
chmod +x build-and-save.sh
./build-and-save.sh
```

### 3. 验证结果

```bash
# 检查生成的文件
ls -lh *.tar.gz

# 验证镜像内容
docker load -i my-ocr-service-v1.0-amd64.tar.gz
docker images | grep my-ocr-service
```

## 注意事项

1. **构建时间**：ARM64 镜像构建时间通常比 AMD64 长 20-50%
2. **文件大小**：两个架构的镜像大小可能略有差异
3. **依赖兼容性**：确保所有 Python 包都支持目标架构
4. **测试验证**：构建完成后建议在对应架构的设备上测试运行

## 故障排除

### 常见问题

1. **构建失败**
   ```bash
   # 清理构建缓存
   docker builder prune -f
   
   # 重新构建
   docker build --no-cache -t my-ocr-service:v1.0-amd64 .
   ```

2. **保存失败**
   ```bash
   # 检查磁盘空间
   df -h
   
   # 清理无用镜像
   docker image prune -f
   ```

3. **架构验证**
   ```bash
   # 检查镜像架构
   docker inspect my-ocr-service:v1.0-amd64 | grep Architecture
   docker inspect my-ocr-service:v1.0-arm64 | grep Architecture
   ```